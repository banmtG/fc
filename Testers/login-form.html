<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login Form</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace.js"></script>
  <link href="./../css/base.css" rel="stylesheet">
  <link href="./../css/index.css" rel="stylesheet">
  <link href="./../css/shoelace_customized.css" rel="stylesheet">
  <script type="module" src="./../components/smart/login-form.js"></script>
</head>
<body>
  <login-form
    options="google,facebook"
    dialog-title="Welcome to FlashCardX"
    auto-close
  ></login-form>

  <div id="user-info"></div>
  <button onclick="callProtected()">Call API</button>
  <button onclick="logout()">Logout</button>


  <!-- ‚ú® New input field for phrases -->
  <input id="searchBatchInput" type="text" placeholder="Enter phrases, separated by commas" style="width: 60%; margin-top:10px;" />
  <button onclick="searchImageMFromInput()">SearchImageM</button>

  <pre id="output"></pre>


  
  <script>
    // --- Step 1: Bootstrap session (guest or authenticated) ---
    function initBootstrap() {
      fetch('https://php.adapps.download/fc/api/bootstrap.php', {
        method: 'GET',
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          console.log('üîë Bootstrap response:', data);

          if (data.mode === 'authenticated') {
            document.getElementById('user-info').textContent =
              `Logged in as ${data.user.email}`;
          } else {
            document.getElementById('user-info').textContent =
              `Guest mode (device token: ${data.device_token})`;
          }
        })
        .catch(err => console.error('‚ùå Error during bootstrap:', err));
    }

    window.addEventListener('DOMContentLoaded', initBootstrap);

    // --- Step 2: Handle login success ---
    document.querySelector('login-form').addEventListener('login-success', (e) => {
      const { provider, email, userId } = e.detail;
      console.log('‚úÖ Logged in via:', provider);
      console.log('üìß Email:', email);
      console.log('üÜî User ID:', userId);

      document.getElementById('user-info').textContent = `Welcome, ${email}`;
    });

  // Generic reusable API call with auto-refresh
  async function callApi(url, options = {}) {
    try {
      // Always include cookies
      const opts = { ...options, credentials: 'include' };

      let res = await fetch(url, opts);

      // If access token expired ‚Üí refresh via bootstrap
      if (res.status === 401) {
        console.warn(`‚ö†Ô∏è Access token expired, refreshing before retrying ${url}...`);

        const refreshRes = await fetch('https://php.adapps.download/fc/api/bootstrap.php', {
          method: 'GET',
          credentials: 'include'
        });
        const refreshData = await refreshRes.json();
        console.log('üîÑ Bootstrap refresh response:', refreshData);

        // Retry original request after refresh
        res = await fetch(url, opts);
      }

      // Return JSON result
      return await res.json();

    } catch (err) {
      console.error(`‚ùå API error calling ${url}:`, err);
      throw err;
    }
  }

  // Example usage: protected API
  async function callProtected() {
    const data = await callApi('https://php.adapps.download/fc/api/protected.php');
    console.log('üì° Protected API response:', data);
    document.getElementById('output').textContent = JSON.stringify(data, null, 2);
  }

   // --- Call searchImageM with POST ---
    async function callSearchImageM(batch) {
      const data = await callApi('https://php.adapps.download/fc/api/searchDict.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ batch })
      });
      console.log('üñºÔ∏è searchImageM response:', data);
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    }

    // --- Get input value, split by commas, and call searchImageM ---
    function searchImageMFromInput() {
      const input = document.getElementById('searchBatchInput').value;
      const batch = input.split(',').map(p => p.trim()).filter(p => p.length > 0);
      if (batch.length === 0) {
        alert('Please enter at least one phrase.');
        return;
      }
      callSearchImageM(batch);
    }


  // Example usage: another API
  async function callProfile() {
    const data = await callApi('https://php.adapps.download/fc/api/profile.php');
    console.log('üë§ Profile API response:', data);
  }

    // --- Step 4: Logout ---
    function logout() {
      fetch('https://php.adapps.download/fc/api/logout.php', {
        method: 'POST',
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          console.log('üö™ Logout response:', data);
          document.getElementById('user-info').textContent =
            'You are now logged out (guest mode)';
          // Optionally re-bootstrap to get a fresh guest device_token
          initBootstrap();
        })
        .catch(err => console.error('‚ùå Logout error:', err));
    }
  </script>
</body>
</html>
