<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login Form</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace.js"></script>
  <link href="./../css/base.css" rel="stylesheet">
  <link href="./../css/index.css" rel="stylesheet">
  <link href="./../css/shoelace_customized.css" rel="stylesheet">
  <script type="module" src="./../components/smart/login-form.js"></script>
</head>
<body>
  <login-form
    options="google,facebook"
    dialog-title="Welcome to FlashCardX"
    auto-close
  ></login-form>

  <div id="user-info"></div>
  <button onclick="callProtected()">Call API</button>
  <button onclick="logout()">Logout</button>
  <pre id="output"></pre>
  
  <script>
    // --- Step 1: Bootstrap session (guest or authenticated) ---
    function initBootstrap() {
      fetch('https://php.adapps.download/fc/api/bootstrap.php', {
        method: 'GET',
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          console.log('üîë Bootstrap response:', data);

          if (data.mode === 'authenticated') {
            document.getElementById('user-info').textContent =
              `Logged in as ${data.user.email}`;
          } else {
            document.getElementById('user-info').textContent =
              `Guest mode (device token: ${data.device_token})`;
          }
        })
        .catch(err => console.error('‚ùå Error during bootstrap:', err));
    }

    window.addEventListener('DOMContentLoaded', initBootstrap);

    // --- Step 2: Handle login success ---
    document.querySelector('login-form').addEventListener('login-success', (e) => {
      const { provider, email, userId } = e.detail;
      console.log('‚úÖ Logged in via:', provider);
      console.log('üìß Email:', email);
      console.log('üÜî User ID:', userId);

      document.getElementById('user-info').textContent = `Welcome, ${email}`;
    });

    // --- Step 3: Call protected API ---
    function callProtected() {
      fetch('https://php.adapps.download/fc/api/protected.php', {
        method: 'GET',
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          console.log('üì° Protected API response:', data);
          document.getElementById('output').textContent =
            JSON.stringify(data, null, 2);
        })
        .catch(err => console.error('‚ùå API error:', err));
    }

    // --- Step 4: Logout ---
    function logout() {
      fetch('https://php.adapps.download/fc/api/logout.php', {
        method: 'POST',
        credentials: 'include'
      })
        .then(res => res.json())
        .then(data => {
          console.log('üö™ Logout response:', data);
          document.getElementById('user-info').textContent =
            'You are now logged out (guest mode)';
          // Optionally re-bootstrap to get a fresh guest device_token
          initBootstrap();
        })
        .catch(err => console.error('‚ùå Logout error:', err));
    }
  </script>
</body>
</html>
