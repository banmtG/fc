<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">  
  <title>Extended SmartTable Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace.js"></script>

  <link href="./../css/base.css" rel="stylesheet">
  <link href="./../css/index.css" rel="stylesheet">
  <link href="./../css/shoelace_customized.css" rel="stylesheet">  <!-- for customized shoelace default value-->      
  <!-- Extended smart-table -->
  <script type="module" src="./../components/smart/extended-smart-table/extended-smart-table.js"></script>
  <script type="module" src="./phraseList.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      width:100%;     
    }

    .legend {
      margin-top: 5px;
      user-select: none;   
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: center;
      gap: 10px;
      overflow-x: scroll;
    }

    .legendItems {
      padding: 4px 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }

    
/* scrollbar */
::-webkit-scrollbar {
  width: 1px;
  height: 1px;
}

::-webkit-scrollbar-track {
  -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
  -webkit-border-radius: 10px;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  -webkit-border-radius: 10px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.3);
  -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
}

::-webkit-scrollbar-thumb:window-inactive {
  background: rgba(255, 255, 255, 0.3);
}

  </style>
</head>
<body>
  <extended-smart-table id="extTbl" search="true" pagination="10,20,50,100,all"></extended-smart-table>
  <div class="legend scrollBar_hidden"></div>
  <a-phrase-mobile-editor></a-phrase-mobile-editor>

  <script type="module">
    import "./../components/smart/star-rating.js";
    import "./../components/fc/a-phrase-mobile-editor.js";
    import Sortable from "./../components/lib/sortableJS/sortable.complete.esm.js";
    import { tableData } from "./phraseList.js"

    import { mapTableData, formatTimestamp, StatusColorData, oldDataBgColor, aPhraseNormalise_NewPhraseTab } from "./../components/smart/smart-table/utils/mapTableData.js";

    const legend = document.querySelector('.legend');
    const merged = { ...StatusColorData, ...{ 'old': oldDataBgColor } }; 
    // console.log(merged);
    for (const key of Object.keys(merged)) {
        // console.log(key);
        // console.log(merged[key]);
        const div = document.createElement('div');
        div.className = "legendItems";
        div.innerHTML = merged[key].legend;
        div.style.backgroundColor = merged[key].bgColor;
        div.style.color = merged[key].color;
        legend.appendChild(div);
    }


    const extTbl = document.getElementById("extTbl");
    const editor = document.querySelector('a-phrase-mobile-editor');

    const theTable = extTbl.shadowRoot.getElementById("tbl").shadowRoot.getElementById("tableBody");
    const editorChildren = editor.shadowRoot.getElementById("container");

    console.log(editorChildren);
        console.log(theTable);
    // Initialize Sortable with multi-drag
    // new Sortable(theTable, {
    //   animation: 150,
    //   multiDrag: true,
    //   selectedClass: "selected",
    //   fallbackTolerance: 3,           
    // });

    // new Sortable(editorChildren, {
    //   animation: 150,
    //     multiDrag: true,
    //     selectedClass: "selected",
    //   fallbackTolerance: 3,           
    // });


    // Host prepares raw data (no mapTableData here)
    extTbl.data = mapTableData(tableData);

    // Pass down columns
    extTbl.setColumns([
      {
    key: "order",
    label: "No",
    interactive: false,
    width_set: { value: "auto", resizable: false },  
    render: (val, obj) => {
      const span = document.createElement("span");
      span.textContent = val;
      // defer until after append
      // console.log(obj);
      setTimeout(() => {
        if (span.parentNode) {
          span.parentNode.style.justifyContent = "center";
          if (obj.orderBgcolor) {
            span.parentNode.style.backgroundColor = obj.orderBgcolor.bgColor;
            span.parentNode.style.color = obj.orderBgcolor.color;
          }
        }
      });
      return span;
    }
  },
  {
    key: "phrase",
    label: "Phrase",
    width_set: {
      value: "4fr",      // fit content width
      min: "100px",
      resizable: true     // allow drag resizing
    }
  },
  {
    key: "status",
    label: "S",
    width_set: {
      value: "25px",      // fit content width
      resizable: false     // allow drag resizing
    },
    render: (val, obj) => {
      const div = document.createElement("div");      
      div.style.width = "100%;"
      div.style.height = "100%;"
      // defer until after append
      setTimeout(() => {
        if (div.parentNode) {
          div.parentNode.style.backgroundColor = obj.statusBgColor.bgColor;
          div.parentNode.style.color = obj.statusBgColor.color;
        }
      });
      return div;
    }
  },
  {
    key: "_actions",
    sortable: false,
    label: "Actions",
    width_set: {       
      value: "80px",      // fit content width
      resizable: false
    },
    interactive: true,
    render: (_, obj) => {
      const div = document.createElement("div");
      div.className = "actions";
      div.innerHTML = `
        <button class="btn btn-edit" data-id="${obj.phraseID}">‚úèÔ∏è</button>
        <button class="btn btn-delete" data-id="${obj.phraseID}">üóëÔ∏è</button>
      `;

      setTimeout(() => {
        if (div.parentNode) {    
            div.parentNode.style.padding = "0px";
            div.parentNode.style.justifyContent = "center";
        }        
      });

      return div;
    },
    events: {
      click: (e, row, obj) => {
        if (e.target.classList.contains("btn-edit")) {
          row.dispatchEvent(new CustomEvent("edit-requested", {
            detail: { id: obj.phraseID },
            bubbles: true,
            composed: true
          }));
        }
        if (e.target.classList.contains("btn-delete")) {
          const msg = "Are you sure you want to delete this row?";
          if (confirm(msg)) {
            row.dispatchEvent(new CustomEvent("delete-requested", {
              detail: { ids: obj.phraseID },
              bubbles: true,
              composed: true
            }));
          }
        }
      }
    }
  }
  // {
  //   key: "rating",
  //   label: "Stars",
  //   interactive: true,
  //   width_set: {
  //     value: "auto",      // fit content width
  //     resizable: true     // allow drag resizing
  //   },
  //   render: (val, obj) => {
  //     const rating = document.createElement("star-rating");
  //     rating.rating = val;
  //     rating.id = obj.id;
  //     rating.setAttribute("row-id", obj.id);
  //     return rating;
  //   }
  // },
  


  // {
  //   key: "phrase",
  //   label: "Reminder",
  //   interactive: true,
  //   width_set: {
  //     value: "auto",      
  //     resizable: false
  //   },
  //   render: (val, obj) => {
  //     const input = document.createElement("input");
  //     input.type = "text";
  //     input.value = val || "";
  //     input.addEventListener("input", e => {
  //       input.dispatchEvent(new CustomEvent("interactive-component-changed", {
  //         detail: { id: obj.id, field: "phrase", value: e.target.value },
  //         bubbles: true,
  //         composed: true
  //       }));
  //     });
  //     return input;
  //   }
  // }
]);
  
  //   extTbl._sortState = { key:"status", dir:"asc" };
  //  // extTbl._pageSize = extTbl._raw.length ;
  //   extTbl.$pageSize.value = "5";
  //   extTbl._onPageSize({ target : { value : "5"}});

    extTbl.setConfig({
      sortKey: "status",
      sortDir: "asc",
      pageSize: "all",
      tableMaxHeight: "30vh",
      idKey : "phraseID"
    })
    //extTbl._runPipeline();
    // Listen to generic events
    // extTbl.addEventListener("interactive-component-changed", e => {
    //   console.log("Interactive change:", e.detail);
    //   // Example: { id: "123", field: "rating", value: 4 }
    // });

    document.addEventListener('edit-requested', (e) => {
      console.log("edit-requested", e.detail.id);
      // console.log(tableData);
      const editItem = tableData.find(item => item.phraseID === e.detail.id);
      console.log(editItem);
      editor.setData = editItem;
    })


    document.addEventListener('highlight-changed', (e) => {
      console.log("highlight-changed", e.detail.id);
      
    })




    // const theTargetID = "phrase-01KE3JYW2F420A1NY6XJANPBXQ";
    // const oldItem = tableData.find( item => item.phraseID === theTargetID);
        
    // oldItem.phrase = "oil the wheel";
    // oldItem.defi = [
    //   {
    //     "pos": "noun",
    //     "info": "",
    //     "definition": "the part of the human brain or personality believed to produce behaviour based on instinct (= natural reactions and behaviours that are not under your conscious control) or emotion, rather than on reasonable thought or on things you have learned:",
    //     "example": "These instinctual animal behaviour patterns are located in what is commonly termed the lizard brain.\nWhy can't I stop scrolling on my phone or eating sweets? I‚Äôm at the mercy of my lizard brain."
    //   }
    // ];
      
    // const normalisedItem = aPhraseNormalise_NewPhraseTab(oldItem);    
    // console.log(normalisedItem);
    // setTimeout(() => {        
    //     extTbl._updateRowData(theTargetID, normalisedItem);
    //     // console.log(extTbl._raw);
    //     extTbl.updateRowUI(theTargetID);
    // }, 5000);

  </script>
</body>
</html>
